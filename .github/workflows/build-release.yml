name: Build and Release RetroSLM

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  build:
    name: ${{ matrix.os }} ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows
            arch: x64
            runner: windows-latest
          - os: windows
            arch: x86
            runner: windows-latest
          - os: macos
            arch: armv8
            runner: macos-15
          - os: macos
            arch: x86_64
            runner: macos-15
          - os: linux
            arch: x86_64
            runner: ubuntu-latest
          - os: linux
            arch: i386
            runner: ubuntu-latest
          - os: linux
            arch: aarch64
            runner: ubuntu-latest
          - os: linux
            arch: armv7
            runner: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Conan
        run: pip install conan

      # --- WINDOWS ---
      - name: Build Windows
        if: matrix.os == 'windows'
        shell: cmd
        run: |
          if not exist "%USERPROFILE%\.conan2\profiles" mkdir "%USERPROFILE%\.conan2\profiles"
          (
          echo [settings]
          echo os=Windows
          echo arch=${{ matrix.arch == 'x64' && 'x86_64' || 'x86' }}
          echo compiler=msvc
          echo compiler.version=193
          echo compiler.cppstd=17
          echo compiler.runtime=dynamic
          echo compiler.runtime_type=Release
          echo build_type=Release
          ) > "%USERPROFILE%\.conan2\profiles\default"
          :: Naprawa skryptu: dodajemy --build=missing do conan install
          powershell -Command "(gc build-conan.cmd) -replace 'conan install', 'conan install . --build=missing' | Out-File -encoding ASCII build-conan.cmd"
          call build-conan.cmd

      # --- MACOS ---
      - name: Build macOS
        if: matrix.os == 'macos'
        run: |
          mkdir -p ~/.conan2/profiles
          cat <<EOF > ~/.conan2/profiles/default
          [settings]
          os=Macos
          arch=${{ matrix.arch }}
          compiler=apple-clang
          compiler.version=15
          compiler.libcxx=libc++
          compiler.cppstd=gnu17
          build_type=Release
          EOF
          # Naprawa skryptu: dodajemy --build=missing
          sed -i '' 's/conan install/conan install . --build=missing/g' build-conan.sh
          chmod +x build-conan.sh
          ./build-conan.sh

      # --- LINUX STANDARD (x86_64) ---
      - name: Build Linux Standard
        if: matrix.os == 'linux' && matrix.arch == 'x86_64'
        run: |
          mkdir -p ~/.conan2/profiles
          cat <<EOF > ~/.conan2/profiles/default
          [settings]
          os=Linux
          arch=x86_64
          compiler=gcc
          compiler.version=11
          compiler.libcxx=libstdc++11
          compiler.cppstd=gnu17
          build_type=Release
          EOF
          sed -i 's/conan install/conan install . --build=missing/g' build-conan.sh
          chmod +x build-conan.sh
          ./build-conan.sh

      # --- LINUX 32-BIT (x86) COMPILE ON x86_64 HOST ---
      - name: Build Linux x86 (32-bit)
        if: matrix.os == 'linux' && matrix.arch == 'i386'
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y gcc-multilib g++-multilib libstdc++6:i386
          mkdir -p ~/.conan2/profiles
          cat <<EOF > ~/.conan2/profiles/x86
          [settings]
          os=Linux
          arch=x86
          compiler=gcc
          compiler.version=$(gcc -dumpversion | cut -d. -f1)
          compiler.libcxx=libstdc++11
          compiler.cppstd=gnu17
          build_type=Release
          EOF
          
          conan install . -pr:b=default -pr:h=x86 --build=missing --output-folder=build

          Konfiguracja CMake z wymuszeniem flagi -m32
          cmake --preset conan-release \
            -DCMAKE_CXX_FLAGS="-m32" \
            -DCMAKE_C_FLAGS="-m32" \
            -DCMAKE_EXE_LINKER_FLAGS="-m32"

          cmake --build --preset conan-release -- -j$(nproc)
          find build -name "RetroSLM" -exec file {} \;

      # --- LINUX ARM64 (aarch64) CROSS-COMPILE ---
      - name: Build Linux ARM64 (aarch64)
        if: matrix.os == 'linux' && matrix.arch == 'aarch64'
        continue-on-error: true
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu binutils-aarch64-linux-gnu
          
          mkdir -p ~/.conan2/profiles
          cat <<EOF > ~/.conan2/profiles/aarch64
          [settings]
          os=Linux
          arch=armv8
          compiler=gcc
          compiler.version=$(gcc -dumpversion | cut -d. -f1)
          compiler.libcxx=libstdc++11
          compiler.cppstd=gnu17
          build_type=Release
          
          [buildenv]
          CC=aarch64-linux-gnu-gcc
          CXX=aarch64-linux-gnu-g++
          AR=aarch64-linux-gnu-ar
          AS=aarch64-linux-gnu-as
          RANLIB=aarch64-linux-gnu-ranlib
          LD=aarch64-linux-gnu-ld
          STRIP=aarch64-linux-gnu-strip
          EOF
          
          conan install . -pr:b=default -pr:h=aarch64 --build=missing --output-folder=build || exit 0
          
          # Konfiguracja CMake z cross-compilation toolchain
          cmake --preset conan-release \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
            -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
            -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ \
            -DCMAKE_FIND_ROOT_PATH=/usr/aarch64-linux-gnu \
            -DCMAKE_FIND_ROOT_PATH_MODE_PROGRAM=NEVER \
            -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY \
            -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY || exit 0

          cmake --build --preset conan-release -- -j$(nproc) || exit 0
          find build -name "RetroSLM" -exec file {} \; || exit 0

      # --- LINUX ARMv7 CROSS-COMPILE ---
      - name: Build Linux ARMv7
        if: matrix.os == 'linux' && matrix.arch == 'armv7'
        continue-on-error: true
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf binutils-arm-linux-gnueabihf
          
          mkdir -p ~/.conan2/profiles
          cat <<EOF > ~/.conan2/profiles/armv7
          [settings]
          os=Linux
          arch=armv7hf
          compiler=gcc
          compiler.version=$(gcc -dumpversion | cut -d. -f1)
          compiler.libcxx=libstdc++11
          compiler.cppstd=gnu17
          build_type=Release
          
          [buildenv]
          CC=arm-linux-gnueabihf-gcc
          CXX=arm-linux-gnueabihf-g++
          AR=arm-linux-gnueabihf-ar
          AS=arm-linux-gnueabihf-as
          RANLIB=arm-linux-gnueabihf-ranlib
          LD=arm-linux-gnueabihf-ld
          STRIP=arm-linux-gnueabihf-strip
          EOF
          
          conan install . -pr:b=default -pr:h=armv7 --build=missing --output-folder=build || exit 0
          
          # Konfiguracja CMake z cross-compilation toolchain
          cmake --preset conan-release \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=armv7l \
            -DCMAKE_C_COMPILER=arm-linux-gnueabihf-gcc \
            -DCMAKE_CXX_COMPILER=arm-linux-gnueabihf-g++ \
            -DCMAKE_FIND_ROOT_PATH=/usr/arm-linux-gnueabihf \
            -DCMAKE_FIND_ROOT_PATH_MODE_PROGRAM=NEVER \
            -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY \
            -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY || exit 0

          cmake --build --preset conan-release -- -j$(nproc) || exit 0
          find build -name "RetroSLM" -exec file {} \; || exit 0
          

      # --- PAKOWANIE ---
      - name: Package Artifacts
        shell: bash
        run: |
          DATE=$(date +'%Y.%m.%d')
          mkdir -p dist
          if [ "${{ matrix.os }}" = "windows" ]; then
            cp output/Release/RetroSLM.exe dist/RetroSLM_${DATE}_win_${{ matrix.arch }}.exe
          else
            cp build/Release/output/RetroSLM dist/RetroSLM_${DATE}_${{ matrix.os }}_${{ matrix.arch }}
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: RetroSLM-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/*

  release:
    needs: build
    runs-on: ubuntu-latest
    if: success() && (github.event_name == 'workflow_dispatch' || github.event_name == 'schedule')
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: ./release-files
          merge-multiple: true
      - id: datetime
        run: echo "now=$(date +'%Y.%m.%d %H:%M')" >> $GITHUB_OUTPUT
      - uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly-${{ github.run_number }}
          name: "Build: ${{ steps.datetime.outputs.now }}"
          files: ./release-files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
