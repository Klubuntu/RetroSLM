name: Build and Release RetroSLM

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  build:
    name: ${{ matrix.os }} ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows
          - os: windows
            arch: x64
            runner: windows-latest
          - os: windows
            arch: x86
            runner: windows-latest
          
          # macOS
          - os: macos
            arch: armv8
            runner: macos-15
          - os: macos
            arch: x86_64
            runner: macos-15

          # Linux
          - os: linux
            arch: x86_64
            runner: ubuntu-latest
          - os: linux
            arch: i386
            runner: ubuntu-latest
          - os: linux
            arch: aarch64
            runner: ubuntu-latest
          - os: linux
            arch: armv7
            runner: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Conan
        run: pip install conan

      # --- KOMPILACJA WINDOWS ---
      - name: Build Windows
        if: matrix.os == 'windows'
        shell: cmd
        run: |
          conan profile detect --force
          :: Ręczne dopisanie standardu i architektury do pliku profilu
          echo compiler.cppstd=17 >> %USERPROFILE%\.conan2\profiles\default
          echo arch=${{ matrix.arch == 'x64' && 'x86_64' || 'x86' }} > %USERPROFILE%\.conan2\profiles\default_temp
          :: Łączymy wykryty profil z naszymi poprawkami
          type %USERPROFILE%\.conan2\profiles\default >> %USERPROFILE%\.conan2\profiles\default_temp
          move /y %USERPROFILE%\.conan2\profiles\default_temp %USERPROFILE%\.conan2\profiles\default
          call build-conan.cmd

      # --- KOMPILACJA MACOS ---
      - name: Build macOS
        if: matrix.os == 'macos'
        run: |
          conan profile detect --force
          echo "compiler.cppstd=17" >> ~/.conan2/profiles/default
          sed -i '' 's/arch=.*/arch=${{ matrix.arch }}/' ~/.conan2/profiles/default
          chmod +x build-conan.sh
          ./build-conan.sh

      # --- KOMPILACJA LINUX (x86_64) ---
      - name: Build Linux Standard
        if: matrix.os == 'linux' && matrix.arch == 'x86_64'
        run: |
          conan profile detect --force
          echo "compiler.cppstd=17" >> ~/.conan2/profiles/default
          chmod +x build-conan.sh
          ./build-conan.sh

      # --- KOMPILACJA LINUX (i386, ARM) ---
      - name: Build Linux Cross-Arch
        if: matrix.os == 'linux' && matrix.arch != 'x86_64'
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: ${{ matrix.arch }}
          distro: ${{ matrix.arch == 'i386' && 'none' || 'ubuntu22.04' }}
          base_image: ${{ matrix.arch == 'i386' && 'i386/ubuntu:bionic' || '' }}
          githubToken: ${{ github.token }}
          install: |
            apt-get update
            apt-get install -y build-essential cmake python3-pip make g++
            pip3 install conan
          run: |
            conan profile detect --force
            echo "compiler.cppstd=17" >> /root/.conan2/profiles/default
            chmod +x build-conan.sh
            # Poprawka dla emulacji (Segfault przy zbyt wielu wątkach)
            sed -i 's/cmake --build ./cmake --build . -- -j2/g' build-conan.sh
            ./build-conan.sh

      # --- PAKOWANIE ---
      - name: Package Artifacts
        shell: bash
        run: |
          DATE=$(date +'%Y.%m.%d')
          mkdir -p dist
          if [ "${{ matrix.os }}" = "windows" ]; then
            TARGET_NAME="RetroSLM_${DATE}_win_${{ matrix.arch }}.exe"
            cp output/RetroSLM.exe dist/${TARGET_NAME} || cp build/Release/RetroSLM.exe dist/${TARGET_NAME}
          else
            TARGET_NAME="RetroSLM_${DATE}_${{ matrix.os }}_${{ matrix.arch }}"
            cp output/RetroSLM dist/${TARGET_NAME} || cp build/RetroSLM dist/${TARGET_NAME}
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: RetroSLM-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/*

  release:
    needs: build
    runs-on: ubuntu-latest
    if: success() && (github.event_name == 'workflow_dispatch' || github.event_name == 'schedule')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./release-files
          merge-multiple: true

      - name: Get current datetime
        id: datetime
        run: echo "now=$(date +'%Y.%m.%d %H:%M')" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly-${{ github.run_number }}
          name: "Build: ${{ steps.datetime.outputs.now }}"
          body: "Automatyczny build RetroSLM (C++17)."
          prerelease: true
          files: ./release-files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
